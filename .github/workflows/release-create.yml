name: "Release: Create"

on:
  workflow_dispatch:
    inputs:
      prs:
        description: 'Pull Requests to Merge (comma separated list)'
        required: true

jobs:
  release-create:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0

      - name: Create Branch Name
        uses: actions/github-script@v6
        id: releaseName
        with:
          script: |
            const release = require('./release.js');
            return release.getBranchName();

      - name: Create Release Branch
        run: |
          git checkout -b release/v${{ steps.releaseName.outputs.result }} main
          git push origin release/v${{ steps.releaseName.outputs.result }} -f

      - name: Update/Create and Merge PRs
        uses: actions/github-script@v6
        id: releasePRs
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const prs = "${{ github.event.inputs.prs }}".split(',').map(pr => pr.trim());
            const branchRelease = ${{ steps.releaseName.outputs.result }};
            const releasePRs = [];

            for (const pr of prs) {
              let title, number;

              try {
                const pull = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: pr,
                });

                if (pull.data.state === 'open') {
                  await github.rest.pulls.update({
                    owner,
                    repo,
                    base: branchRelease,
                    pull_number: pr,
                  });

                  title = pull.data.title;
                  number = pull.data.number;
                } else {
                  const pullCreated = await github.rest.pulls.create({
                    owner,
                    repo,
                    base: branchRelease,
                    head: pull.data.head.ref,
                    title: pull.data.title,
                    body: pull.data.body,
                  });

                  title = pullCreated.data.title;
                  number = pullCreated.data.number;
                }

                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: number,
                  merge_method: "squash",
                  sha: pull.data.head.sha,
                });

                releasePRs.push({ title, number });
              } catch (error) {
                console.log(error);
                continue;
              }
            }

            return releasePRs;

#      - name: Merge PRs into Release Branch
#        uses: actions/github-script@v6
#        with:
#          github-token: ${{secrets.GITHUB_TOKEN}}
#          script: |
#            const { repo, owner } = context.repo;
#            const releasePRs = ${{ steps.releasePRs.outputs.result }};
#
#            for (const pr of releasePRs) {
#              try {
#                await github.rest.pulls.merge({
#                  owner,
#                  repo,
#                  pull_number: pr.number,
#                  merge_method: "squash"
#                  sha: pullRequestStage.data.head.sha,
#                });
#              } catch (error) {
#                console.log(error);
#                continue;
#              }
#            }

      - name: Create Release PR
        uses: actions/github-script@v6
        with:
          script: |
            const { repo, owner } = context.repo;
            const branchRelease = ${{ steps.releaseName.outputs.result }};

            try {
              await github.rest.pulls.create({
                owner,
                repo,
                title: "release | v24.1.22",
                head: branchRelease,
                base: "main",
                body: `This PR includes merged demands:\n\n${{ github.event.inputs.prs }}`
              });
            } catch (error) {
              console.log(error);
            }
