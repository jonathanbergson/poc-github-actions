name: "Release: Create"

on:
  workflow_dispatch:
    inputs:
      prs:
        description: 'Pull Requests to Merge (comma separated list)'
        required: true

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0

      - name: Create Version
        uses: actions/github-script@v6
        id: release
        with:
          script: |
            const currentDate = new Date()
            const year = currentDate.getFullYear().toString().slice(2)
            const month = currentDate.getMonth()
            const date = currentDate.getDate()
            const version = year + '.' + month + '.' + date
            return version

      - name: Create Release Branch
        run: |
          git checkout -b release/v${{ fromJSON(steps.release.outputs.result) }} main
          git push origin release/v${{ fromJSON(steps.release.outputs.result) }}

      - name: Change PR base
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = "${{ fromJSON(steps.release.outputs.result) }}";
            const prs = "${{ github.event.inputs.prs }}".split(",").map(pr => pr.trim());

            console.log('version', version);
            console.log('prs', prs);

            for (const pr of prs) {
              const pull = await github.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr
              });

              if (pull.data.base.ref !== version) {
                await github.pulls.update({
                  base: version,
                  pull_number: pr,
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
              }
            }

#      # Merge PRs into release branch
#      - name: Merge PRs
#        uses: actions/github-script@v6
#        with:
#          github-token: ${{secrets.GITHUB_TOKEN}}
#          script: |
#            const prs = "${{ github.event.inputs.prs }}".split(",");
#            for (const pr of prs) {
#              await github.pulls.merge({
#                owner: context.repo.owner,
#                repo: context.repo.repo,
#                pull_number: pr.trim(),
#                merge_method: "squash"
#              });
#            }
#
#      # Create a pull request from release branch to main
#      - name: Create PR
#        uses: actions/github-script@v6
#        with:
#          github-token: ${{secrets.GITHUB_TOKEN}}
#          script: |
#            await github.pulls.create({
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              title: "Merge release/v24.1.22 into main",
#              head: "release/v24.1.22",
#              base: "main",
#              body: `This PR includes merged demands:\n\n${{ github.event.inputs.prs }}`
#            });
